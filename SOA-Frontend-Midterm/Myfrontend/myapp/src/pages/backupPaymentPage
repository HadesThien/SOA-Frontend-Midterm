import React, { useState } from "react";
import {
  Box,
  Typography,
  TextField,
  Button,
  Alert,
  Divider,
  Card,
  CardContent,
  Avatar,
  Grid,
  Checkbox,
  FormControlLabel,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow
} from "@mui/material";
import AccountCircleIcon from "@mui/icons-material/AccountCircle";
import AccountBalanceWalletIcon from "@mui/icons-material/AccountBalanceWallet";
// import { findUserByStudentId } from "../api/userApi";
import { getTuitionsByStudentId } from "../api/tuitionsApi";
import CircularProgress from "@mui/material/CircularProgress";
import Backdrop from "@mui/material/Backdrop";
import Snackbar from "@mui/material/Snackbar";
import MuiAlert from "@mui/material/Alert";
import PhoneIcon from "@mui/icons-material/Phone";


import { addTransaction, verifyTransactionReal } from "../api/transactionApi";
import * as transactionApi from "../api/transactionApi";
console.log("Available exports:", transactionApi);

export default function PaymentPage({ currentUser }) {
  const [studentId, setStudentId] = useState("");
  const [targetUser, setTargetUser] = useState(null);
  const [error, setError] = useState(""); 
  const [otpError, setOtpError] = useState(""); 
  const [successMsg, setSuccessMsg] = useState("");
  const [otpStage, setOtpStage] = useState(null);
  const [otpInput, setOtpInput] = useState("");
  const [agreed, setAgreed] = useState(false);
  const [loadingCreate, setLoadingCreate] = useState(false);
  const [loadingVerify, setLoadingVerify] = useState(false);
  const [otpDialogOpen, setOtpDialogOpen] = useState(false);
  const [confirmCloseOtp, setConfirmCloseOtp] = useState(false);
  const [confirmDialogOpen, setConfirmDialogOpen] = useState(false);
  const [selectedFee, setSelectedFee] = useState(null);
  const [agreedConfirm, setAgreedConfirm] = useState(false);
  const [pendingPaymentId, setPendingPaymentId] = useState(null);
  const [isLoadingStatus, setIsLoadingStatus] = useState(false);
  const [loadingSearch, setLoadingSearch] = useState(false);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMsg, setSnackbarMsg] = useState("");
  const [snackbarSeverity, setSnackbarSeverity] = useState("info"); // "error", "success", "warning", "info"



  //Tra c·ª©u h·ªçc ph√≠
  const handleSearch = async () => {
    setError("");
    setSuccessMsg("");
    setOtpError("");
    setTargetUser(null);
    setLoadingSearch(true);
    await new Promise((r) => setTimeout(r, 500)); // delay 500ms

    if (!studentId) {
      // setError("Vui l√≤ng nh·∫≠p m√£ sinh vi√™n");
      showSnackbar("Kh√¥ng t√¨m th·∫•y m√£ sinh vi√™n n√†y", "error");
      setLoadingSearch(false);
      return;
    }

    try {
      const data = await getTuitionsByStudentId(studentId);
      console.log("Danh s√°ch h·ªçc ph√≠", data.tuitions);

      if(!data || !data.tuitions || data.tuitions.length ===0){
        // setError("Kh√¥ng t√¨m th·∫•y h·ªçc ph√≠ cho m√£ sinh vi√™n n√†y");
        showSnackbar("Kh√¥ng t√¨m th·∫•y sinh vi√™n n√†y", "error");
      } else{
        showSnackbar("Tra c·ª©u th√†nh c√¥ng!", "success");
        setTargetUser({
          studentId: data.student_id,
          fullname: "Sinh vi√™n " + data.student_id,
          tuition: data.tuitions,
        });
      }
    } catch (err) {
      setError("L·ªói khi t√¨m ki·∫øm h·ªçc ph√≠");
    } finally {
      setLoadingSearch(false);
    }   
  };

  //H√†m hi·ªÉn th·ªã Snackbar
  const showSnackbar = (message, severity = "info") => {
    setSnackbarMsg(message);
    setSnackbarSeverity(severity);
    setSnackbarOpen(true);
  };


// const handleRefetchWithLoading = () => {
//   setIsLoadingStatus(true);
//   refetchTuition().finally(() => {
//     setIsLoadingStatus(false);
//   });
// };

const handleRefetchWithLoading = () => {
  setIsLoadingStatus(true);
  setTimeout(() => {
    refetchTuition().finally(() => {
      setIsLoadingStatus(false);
    });
  }, 500); // delay 500ms ƒë·ªÉ spinner k·ªãp hi·ªÉn th·ªã
};



const handleConfirmOtp = async () => {
  setOtpError(""); // reset l·ªói c≈©
  setSuccessMsg(""); // reset th√¥ng b√°o c≈©
  setLoadingVerify(true);

  if (!otpInput || otpInput.length !== 6) {
    setOtpError("Vui l√≤ng nh·∫≠p m√£ OTP h·ª£p l·ªá (6 ch·ªØ s·ªë).");
    setLoadingVerify(false);
    return;
  }
  try {
    const paymentId = otpStage?.payment_id;
    if (!paymentId){
      setOtpError("Kh√¥ng th·ªÉ l·∫•y m√£ giao d·ªãch.");
      setLoadingVerify(false);
      return;
    }

    const verifyResponse = await verifyTransactionReal({
      email: currentUser.email,
      payment_id: paymentId,
      otp: otpInput
    });

    if (
      verifyResponse.message?.toLowerCase().includes("invalid") ||
      verifyResponse.success === false
    ) {
      // setOtpError(verifyResponse.message || "X√°c th·ª±c OTP kh√¥ng th√†nh c√¥ng.");
      //showSnackbar(verifyResponse.message || "X√°c th·ª±c OTP kh√¥ng th√†nh c√¥ng.", "error");
      showSnackbar("M√£ OTP kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.", "error"); 
      setLoadingVerify(false);
      setPendingPaymentId(paymentId);

      return;
    }

    currentUser.available_balance -= otpStage.amount;
    const updatedTuition = targetUser.tuition.map((t) =>
      t.id === otpStage.id ? { ...t, paid: true, status: "PAID" } : t
    );
    setTargetUser({ ...targetUser, tuition: updatedTuition });

    // setSuccessMsg(` Thanh to√°n th√†nh c√¥ng cho kho·∫£n ${otpStage.title}!`);
    showSnackbar(` Thanh to√°n th√†nh c√¥ng cho kho·∫£n ${otpStage.title}!`, "success");
    setOtpStage(null);
    setOtpInput("");
    setAgreed(false);
    setOtpDialogOpen(false); // ƒë√≥ng pop-up
  } catch (err) {
    setOtpError(err.message || "L·ªói x√°c th·ª±c OTP");
  } finally {
    setLoadingVerify(false);
  }

  const updated = await getTuitionsByStudentId(studentId);
  setTargetUser({
    studentId: updated.student_id,
    fullname: "Sinh vi√™n " + updated.student_id,
    tuition: updated.tuitions
  });
}

  const refetchTuition = async () => {
          try {
            const updated = await getTuitionsByStudentId(studentId);
            setTargetUser({
              studentId: updated.student_id,
              fullname: "Sinh vi√™n " + updated.student_id,
              tuition: updated.tuitions
            });
          } catch (err) {
            console.error("L·ªói khi refetch h·ªçc ph√≠:", err);
          }
        };

  const handleCancelOtp = () => {
    // ƒê√≥ng giao di·ªán OTP
      setOtpDialogOpen(false);
      setConfirmCloseOtp(false);

      // Gi·ªØ l·∫°i th√¥ng tin giao d·ªãch (otpStage) trong 3 ph√∫t ƒë·ªÉ Redis c√≥ th·ªÉ expire
      // Kh√¥ng g·ªçi setOtpStage(null) ngay l·∫≠p t·ª©c

      // Reset c√°c input v√† th√¥ng b√°o
      setOtpInput("");
      setOtpError("");
      setAgreed(false);
      setSuccessMsg("H·ªá th·ªëng s·∫Ω ho√†n t√°c giao d·ªãch sau kho·∫£ng 3 ph√∫t n·∫øu OTP kh√¥ng ƒë∆∞·ª£c x√°c th·ª±c.");

      // Sau ƒë√∫ng 3 ph√∫t, x√≥a otpStage v√† refetch h·ªçc ph√≠ ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i t·ª´ DB
      setTimeout(() => {
        setOtpStage(null); // x√≥a th√¥ng tin giao d·ªãch sau khi Redis ƒë√£ x·ª≠ l√Ω
        setPendingPaymentId(null); // cho ph√©p t·∫°o l·∫°i giao d·ªãch sau 3 ph√∫t
        // refetchTuition();  // g·ªçi l·∫°i API ƒë·ªÉ l·∫•y tr·∫°ng th√°i m·ªõi t·ª´ DB
        handleRefetchWithLoading();
      }, 180000);

      // G·ªçi l·∫°i th√™m 2 l·∫ßn sau ƒë√≥ ƒë·ªÉ ƒë·∫£m b·∫£o frontend b·∫Øt ƒë∆∞·ª£c tr·∫°ng th√°i m·ªõi
      [183000, 186000].forEach((delay) => {
        setTimeout(() => {
          // refetchTuition();
          handleRefetchWithLoading();
        }, delay);
      });
    };


  const handlePayment = (fee) => {
  setError("");
  setSelectedFee(fee);
  setAgreedConfirm(false);
  setConfirmDialogOpen(true); // m·ªü form x√°c nh·∫≠n
};

  const handleConfirmPayment = async () => {
    if (!selectedFee || !agreedConfirm) return;
    console.log("S·ªë d∆∞:", currentUser.available_balance, "Gi√° ti·ªÅn:", selectedFee.amount);
    if (currentUser.available_balance < selectedFee.amount) {
      // setError("S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ thanh to√°n kho·∫£n n√†y. Vui l√≤ng n·∫°p th√™m");
      // setConfirmDialogOpen(false);
      showSnackbar("S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ thanh to√°n kho·∫£n n√†y. Vui l√≤ng n·∫°p th√™m", "error");
      setConfirmDialogOpen(false);
      return;
    }
      setLoadingCreate(true);
      try {
        const response = await addTransaction(selectedFee.id);
        const paymentId = response?.payment_id || response?.id;

        if (response?.success === false || !paymentId) {
          const msg = response?.message || "Kh√¥ng th·ªÉ t·∫°o giao d·ªãch";
          // setError(response.message || "Kh√¥ng th·ªÉ t·∫°o giao d·ªãch");
          showSnackbar(msg, "error");
          // setLoadingCreate(false);
          setConfirmDialogOpen(false);
          return;
        }

        // ‚úÖ C·∫≠p nh·∫≠t tr·∫°ng th√°i t·∫°m th·ªùi ngay
        const updatedTuition = targetUser.tuition.map((t) =>
          t.id === selectedFee.id ? { ...t, status: "IN_PROCESS" } : t
        );
        setTargetUser({ ...targetUser, tuition: updatedTuition });

        // ‚úÖ M·ªü OTP
        setOtpStage({ ...selectedFee, payment_id: paymentId });
        setOtpInput("");
        setOtpError("");
        setSuccessMsg("");
        setOtpDialogOpen(true);
        setConfirmDialogOpen(false);
      } catch (err) {
        // setError(err.message || "L·ªói khi t·∫°o giao d·ªãch");
        showSnackbar(err.message || "L·ªói khi t·∫°o giao d·ªãch", "error");
        setConfirmDialogOpen(false);
      } finally {
        setLoadingCreate(false);
      }
  };


  return (
    <Box sx={{ p: 3 }}>
      <Typography variant="h5" gutterBottom fontWeight="bold">
        Thanh to√°n h·ªçc ph√≠
      </Typography>

      {/* Th√¥ng tin t√†i kho·∫£n hi·ªán t·∫°i */}
      <Card
        sx={{
          mb: 3,
          p: 2,
          borderRadius: 3,
          boxShadow: 3,
          background: "linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%)",
        }}
      >
        <Grid container spacing={2} alignItems="center">
          <Grid item>
            <Avatar
              sx={{ bgcolor: "#3f51b5", width: 56, height: 56 }}
            >
              <AccountCircleIcon fontSize="large" />
            </Avatar>
          </Grid>
          <Grid item xs>
            <Typography variant="subtitle1" fontWeight="bold">
              {currentUser.fullname}
            </Typography>
            <Typography color="text.secondary">
              üìû {currentUser.phone}
            </Typography>
            <Box sx={{ display: "flex", alignItems: "center", mt: 0.5 }}>
              <AccountBalanceWalletIcon sx={{ mr: 0.5, color: "green" }} />
              
              {/* <Typography fontWeight="bold" color="green">
                {currentUser.available_balance.toLocaleString()} VND
              </Typography> */}

            <Typography fontWeight="bold" color="green">
              {typeof currentUser?.available_balance === "number"
                ? currentUser.available_balance.toLocaleString() + " VND"
                : "N/A"}
            </Typography>

            </Box>
          </Grid>
        </Grid>
      </Card>

      {/* Form nh·∫≠p m√£ SV */}
      <Box sx={{ display: "flex", gap: 2, mb: 2 }}>
        <TextField
          label="M√£ sinh vi√™n"
          value={studentId}
          onChange={(e) => setStudentId(e.target.value)}
        />
        <Button variant="contained" onClick={handleSearch}>
          Tra c·ª©u
        </Button>
        {loadingSearch && (
          <Box sx={{ display: "flex", justifyContent: "center", my: 2 }}>
            <CircularProgress size={24} />
          </Box>
        )}

      </Box>

      {error && <Alert severity="error">{error}</Alert>}
      {otpError && <Alert severity="error">{otpError}</Alert>}
      {successMsg && <Alert severity="success">{successMsg}</Alert>}

      {/* Th√¥ng tin h·ªçc ph√≠ */}
      {targetUser && (
        <Card sx={{ mt: 3 }}>
          <CardContent>
            <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}>
              <Typography variant="h6">
                Th√¥ng tin h·ªçc ph√≠, l·ªá ph√≠:
              </Typography>
              <Typography variant="h6" color="text.secondary">
                {targetUser.fullname}
              </Typography>
            </Box>

            {successMsg && <Alert severity="success" sx={{ mb: 2 }}>{successMsg}</Alert>}


            <Divider sx={{ my: 2 }} />

            {(isLoadingStatus || loadingSearch) &&(
              <Box sx={{ display: "flex", justifyContent: "center", my: 2 }}>
                <CircularProgress size={24} />
              </Box>
            )}

            <TableContainer>
              <Table size="small">
                <TableHead>
                  <TableRow>
                    <TableCell>ID</TableCell>
                    <TableCell>M√£ SV</TableCell>
                    <TableCell>M√¥ t·∫£</TableCell>
                    <TableCell>Gi√° ti·ªÅn</TableCell>
                    <TableCell>H·∫°n thanh to√°n</TableCell>
                    <TableCell>Tr·∫°ng th√°i</TableCell>
                    <TableCell>H√†nh ƒë·ªông</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {targetUser.tuition.map((fee) => (
                    <TableRow key={fee.id}>
                      <TableCell>{fee.id}</TableCell>
                      <TableCell>{fee.student_id}</TableCell>
                      <TableCell>{fee.description}</TableCell>
                      <TableCell>
                        {typeof fee.amount === "number"
                          ? fee.amount.toLocaleString() + " VND"
                          : "N/A"}
                      </TableCell>
                      {/* <TableCell>
                        {fee.expired_at
                          ? new Date(fee.expired_at).toLocaleDateString("vi-VN")
                          : "Kh√¥ng r√µ"}
                      </TableCell> */}
                      <TableCell>{fee.expires_at}</TableCell>
                      <TableCell>
                        <Typography
                          fontWeight="bold"
                          color={
                            fee.status === "PAID"
                              ? "green"
                              : fee.status === "IN_PROCESS"
                              ? "orange"
                              : fee.status === "EXPIRED"
                              ? "gray"
                              : "red"
                          }
                        >
                          {fee.status === "PAID"
                            ? "ƒê√£ thanh to√°n"
                            : fee.status === "IN_PROCESS"
                            ? "ƒêang x·ª≠ l√Ω"
                            : fee.status === "EXPIRED"
                            ? "H·∫øt h·∫°n"
                            : "Ch∆∞a thanh to√°n"}
                        </Typography>
                      </TableCell>
                      <TableCell>
                        {fee.status === "NOT_YET_PAID" && !otpStage && fee.id !== pendingPaymentId && (
                          <Button
                            variant="contained"
                            size="small"
                            onClick={() => handlePayment(fee)}
                            disabled={loadingCreate}
                            sx={{
                              bgcolor: "#d32f2f", 
                              color: "white",
                              fontWeight: "bold",
                              textTransform: "none",
                              px: 2,
                              py: 1,
                              borderRadius: 2,
                              "&:hover": { 
                                bgcolor: "#b71c1c" },
                            }}
                          >
                            {loadingCreate ? "ƒêang x·ª≠ l√Ω..." : "Thanh to√°n"}
                          </Button>
                        )}
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>

          </CardContent>
        </Card>
      )}

      <Dialog open={confirmDialogOpen} onClose={() => setConfirmDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>X√°c nh·∫≠n thanh to√°n</DialogTitle>
        <DialogContent>
          <Typography>B·∫°n c√≥ ch·∫Øc mu·ªën thanh to√°n kho·∫£n:</Typography>
          <Typography fontWeight="bold" sx={{ mt: 1 }}>
            {selectedFee?.title}
          </Typography>
          <Typography color="text.secondary">
            S·ªë ti·ªÅn: {typeof selectedFee?.amount === "number"
              ? selectedFee.amount.toLocaleString() + " VND"
              : "N/A"}
          </Typography>

          <FormControlLabel
            control={
              <Checkbox
                checked={agreedConfirm}
                onChange={(e) => setAgreedConfirm(e.target.checked)}
              />
            }
            label="T√¥i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n thanh to√°n"
            sx={{ mt: 2 }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setConfirmDialogOpen(false)}>H·ªßy</Button>
          <Button
            variant="contained"
            disabled={!agreedConfirm || loadingCreate}
            onClick={handleConfirmPayment}
          >
            {loadingCreate ? "ƒêang x·ª≠ l√Ω..." : "X√°c nh·∫≠n"}
          </Button>
        </DialogActions>
      </Dialog>


      {/* Giao di·ªán OTP */}
      
      <Dialog open={otpDialogOpen} onClose={() => setConfirmCloseOtp(true)} maxWidth="sm" fullWidth>
        <DialogTitle>X√°c nh·∫≠n thanh to√°n</DialogTitle>
        <DialogContent>
          <Typography color="text.secondary">
            M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email <b>{currentUser.email}</b>. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ ƒë·∫øn ho·∫∑c th∆∞ r√°c.
          </Typography>

          <Typography sx={{ mt: 1 }}>
            S·ªë ti·ªÅn: {typeof otpStage?.amount === "number"
              ? otpStage.amount.toLocaleString() + " VND"
              : "N/A"}
          </Typography>

          <TextField
            fullWidth
            sx={{ mt: 2 }}
            label="Nh·∫≠p OTP"
            value={otpInput}
            onChange={(e) => setOtpInput(e.target.value)}
          />

          {otpError && <Alert severity="error" sx={{ mt: 2 }}>{otpError}</Alert>}
          {successMsg && <Alert severity="success" sx={{ mt: 2 }}>{successMsg}</Alert>}
        </DialogContent>

        <DialogActions>
          <Button onClick={() => setConfirmCloseOtp(true)}>H·ªßy</Button>
          <Button
            variant="contained"
            disabled={loadingVerify}
            onClick={handleConfirmOtp}
          >
            {loadingVerify ? "ƒêang x√°c th·ª±c..." : "X√°c nh·∫≠n"}
          </Button>
        </DialogActions>
      </Dialog>

            <Dialog open={confirmCloseOtp} onClose={() => setConfirmCloseOtp(false)}>

        <DialogTitle>X√°c nh·∫≠n h·ªßy thanh to√°n</DialogTitle>
        <DialogContent>
          <Typography>B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t kh·ªèi b∆∞·ªõc x√°c th·ª±c OTP kh√¥ng?</Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setConfirmCloseOtp(false)}>Kh√¥ng</Button>
          <Button
            color="error"
            onClick={() => {
              setConfirmCloseOtp(false);
              setOtpDialogOpen(false);
              setOtpStage(null);
              setOtpInput("");
              setAgreed(false);
              setOtpError("");

              // ƒê·ª£i redis x·ª≠ l√≠ xong r·ªìi m·ªõi c·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i h·ªçc ph√≠
              // G·ªçi l·∫°i 3 l·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o Redis ƒë√£ x·ª≠ l√Ω
              [5000, 10000, 15000].forEach((delay) => {
                setTimeout(() => {
                  handleRefetchWithLoading();
                }, delay);
              });

            }}
          >
            C√≥, tho√°t
          </Button>
        </DialogActions>
      </Dialog>

      <Backdrop
        open={loadingCreate || loadingVerify || isLoadingStatus || loadingSearch}
        sx={{ zIndex: 9999, color: "#fff", transition: "opacity 0.3s ease-in-out" }}
      >
        <CircularProgress color="inherit" />
      </Backdrop>

      <Snackbar
        open={snackbarOpen}
        autoHideDuration={4000}
        onClose={() => setSnackbarOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
      >
        <MuiAlert
          elevation={6}
          variant="filled"
          onClose={() => setSnackbarOpen(false)}
          severity={snackbarSeverity}
          sx={{ width: "100%" }}
        >
          {snackbarMsg}
        </MuiAlert>
      </Snackbar>


    </Box>


    
  );
}